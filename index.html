<html>
	<head>
		<script type="text/javascript" src="./jquery-1.11.1.min.js"></script>
		<script type="text/javascript" src="./minuet.js"></script>
		<script type="text/javascript" src="./trio.js"></script>
		<style>
			button.bar {
				width: 40px;
				text-align: center;
			}

			button.song {
				background-color: lightgreen;
				width: 40px;
				text-align: center;				
			}
		</style>
	</head>
	<body>
		<div id="minuets"></div>
		<div id="trios"></div>
		<audio id="player" controls>
			Your browser does not support the audio element.
		</audio><br>
		Current playing: <input type="text" id="playing"><br>
		Queue: <input type="text" id="queue" size="80"><br>
		Song: <input type="text" id="song" size="80"><br>
		<button onclick="playSong();">Play song</button><br>
		<button onclick="song_generate('M');">Generate minuet</button><br>
		<button onclick="song_generate('T');">Generate trio</button><br>
		<br>
		<script type="text/javascript">
			// Parameters
			var DEBUG = true;

			// Constants
			var dir = "./mp3/";
			var ext = ".mp3"

			// Html elements
			var player = document.getElementById('player');

			// Variables
			var queue = new Array();
			var playing = "";
			var song = new Array();
			
			// Functions
			function var_exist(id) {
				if(id == undefined || id == null) {
					alert("ERROR: Script not working properly!");
					throw "Variable \""+id+"\" not defined or null!";
				}
			}

			function html_get(id) {
				var element = $("#"+id);
				if(element.length <= 0 || element == undefined || element == null) {
					alert("ERROR: Page not loaded properly!");
					throw "HTML element "+id+" not found!";
				}
				return element;
			}

			function player_exist() {
				if(player == null || player == undefined) {
					alert("ERROR: Player element not found!");
					throw "Player not found!"
				}
			}

			function debug(text) {
				if(!DEBUG) return;
				console.log(text);
			}

			function switchBar(id) {
				var_exist(id);
			}
			
			function playFile(id) {
				var_exist(id);
				player_exist();
				var_exist(song);

				/*if(song.length > 0) {
						switchBar(id);
						return;
				}*/

				if(playing == id) {
					player.play();
				} else {
					playerClean();
					playerAddFile(id);
					player.play();
				}
			}

			function playerAddFile(id) {
				player_exist();
				file = dir+id+ext;
				debug("playerAddFile("+id+"):"+file);
				player.innerHTML = "<source src=\""+file+"\" type=\"audio/mpeg\">";
				playing = id;
				preview();
				player.load();
			}
			
			function playerClean() {
				debug("playerClean():");
				player_exist();
				debug("playerClean()");
				player.innerHTML = '';
				player.load();
			}

			function playStop() {
				debug("playStop():")
				var_exist(playing);
				var_exist(queue);
				player_exist();
				player.innerHTML = '';
				playing = '';
				preview();
				if(queue.length > 0) {
					playFile(queue[0]);
					queue.shift(); // Remove first element;
				}
			}
			
			function playSong() {
				debug("playSong():");

				var_exist(song);
				var_exist(queue);
				var_exist(playing);

				if(song.length <= 0) {
					alert("You must generate song at first.")
					return;
				}

				if(queue.lenth == 0) {
					// Song was all played, start again
					queue = song;
				}

				playFile(queue[0]);
				queue.shift();

				if(playing != "") {

				}
				//player.addEventListener("onended", playSong);

				/*if(playlist.length == 0) {
					alert("ERROR: Empty playlist!");
					return;
				}
				debug("\tplaylist["+playlist.length+"]: "+playlist.toString());
				if(player == null) {
					alert("ERROR: Player element not found!");
					return;
				}
				
				debug("\tplayer: ");
				debug("\t\tpaused: "+player.paused);
				debug("\t\tended: "+player.ended);
				if(player.audioTracks.length == 0) {
					if(playing == playlist.length -1 ) { // Last song played
						playing = 0;
					}
				}
				player.play();*/
			}

			function dice_toss(top) {
				// Generate number in the interval <0;top)
				return Math.floor(Math.random() * top);
			}

			function preview() {
				debug("preview()");
				var_exist(song);
				var_exist(queue);
				var_exist(playing);

				var html_song = html_get("song");
				var html_queue = html_get("queue");
				var html_playing = html_get("playing");

				html_song.val(song.join(","));
				html_queue.val(queue.join(","));
				html_playing.val(playing);

				player.load();
			}

			function song_clear() {
				// Clear song and queue
				song = [];
				queue = [];
				playing = "";
				// Remove files from player
				player.innerHTML = '';
				// Reload variables and player
				preview();
				// Clear selections
				$('.song').removeClass('song');
			}

			function get_html_bars(id) {
				debug("get_html_bars("+id+")");
				switch(id) {
					case 'M':
						html_bars = html_get("minuets");
					break
					case 'T':
						html_bars = html_get("trios");
					break
					default:
						alert("ERROR: Unknow type of song!");
						throw "Wrong type "+id+" for get_html_bars()";
				}
				return html_bars;
			}

			function get_bars(id) {
				debug("get_bars("+id+")");
				switch(id) {
					case 'M':
						bars = minuet;
					break
					case 'T':
						bars = trio;
					break
					default:
						alert("ERROR: Unknow type of song!");
						throw "Wrong type "+id+" for get_bars()";
				}
				var_exist(bars);
				return bars;
			}

			function song_generate(id) {
				debug("song_generate("+id+")");

				bars = get_bars(id);

				var_exist(bars);
				var_exist(song);
				var_exist(queue);

				var rows = bars.length;
				var cols = bars[0].length;

				song_clear();

				debug("rows: "+rows+", cols: "+cols);

				for(col = 0; col < cols; col++) {
					row = dice_toss(rows);
					bar = bars[row][col];
					song.push(id+bar);
					html_get(id+bar).addClass('song');
				}
				queue = song;
				debug(song);
				preview();
			}

			function bars_init(id) {
				debug("bars_init("+id+")");
				bars = get_bars(id);
				html_bars = get_html_bars(id);

				var rows = bars.length;
				
				var html = '';
				html += '<table border="1">'
				for(r = 0; r < rows; r++) {
					html += '<tr>';
					for(c = 0; c < bars[r].length; c++) {
						var bar = bars[r][c];
						html += '<td><button class="bar bar'+c+'" id="'+id+bar+'" onclick="playFile(\''+id+bar+'\')">'+bar+'</button></td>';
					}
					html += '</tr>';
				}
				html += '</table>'
				html_bars.html(html);
			}

			function player_init(){
				player_exist();
				player.addEventListener("ended", playStop);
			}

			// MAIN
			bars_init("M");
			bars_init("T");
			player_init();
		</script>
	</body>
</html>
